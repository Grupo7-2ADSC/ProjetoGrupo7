<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="./painel.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <title>Painel</title>
</head>

<body>

    <div class="sidebar">
        <div class="divImg">

            <img id="imagemUser" src="./assets/logo_roxa.png" alt="">
        </div>

        <div class="NomeUsuario">OlÃ¡, <span id="nomeUser" class="NomeUsuario"></span></div>

        <ul>
            <li><a class="button" href="./avisos.html"><img class="icone-menu" src="./assets/sino-de-notificacao.png"
                        alt="">Avisos â€Ž â€Ž â€Ž </a></li>
            <li><a class="buttonSelecionado"><img class="icone-menu" src="./assets/painel.png" alt=""> Painel â€Ž â€Ž
                    â€Ž</a></li>
            <li><a class="button" href="./relatorio.html"><img class="icone-menu" src="./assets/relatorio-de-lucro.png"
                        alt="">RelÃ¡torio</a></li>
            <li><a class="button" href="./usuarios.html"><img class="icone-menu" src="./assets/silhueta-de-multiplos-usuarios.png"
                        alt="">UsuÃ¡rios</a></li>
            <br>
            <br>
        </ul>
        <div class="exitContainer"><button class="exitButton" onclick="logout()"><span class='text'>Sair</span><span
                    class="icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                        <path
                            d="M24 20.188l-8.315-8.209 8.2-8.282-3.697-3.697-8.212 8.318-8.31-8.203-3.666 3.666 8.321 8.24-8.206 8.313 3.666 3.666 8.237-8.318 8.285 8.203z" />
                    </svg></span></button></div>

    </div>

    <main class="main-content">
        <h1 class="titulo">Painel Geral</h1>

        <div class="container-card-main">

            <div class="card-kpi">
                <p class="conteudo-card">Quantidade de Servidores com uso de RAM acima de <span
                        id="paramMaxRam"></span>%</p>
                <span class="conteudo-card" id="totalServersRamUp"></span>
            </div>

            <div class="card-kpi">
                <p class="conteudo-card">Quantidade de Servidores com pouco espaÃ§o em disco <span
                        id="paramMaxDisco"></span>%</p>
                <span class="conteudo-card" id="qtdDiscosMinSpace"></span>
            </div>


            <div class="card-kpi">
                <p class="conteudo-card">Quantidade de Servidores com uso de CPU acima de <span
                        id="paramMaxCpu"></span>%</p>
                <span class="conteudo-card" id="totalServersCpuUp"></span>
            </div>

            <div class="card-kpi">
                <p class="conteudo-card">Total de Servidores</p>
                <span class="conteudo-card" id="totalServers"></span>
            </div>

        </div>

        <div class="conjunto-seletor">
            <div class="seletor-filtro">
                <p>Filtrar servidores por indicador</p>
                <select class="" name="seletor de filtro" id="select-indicador" alt="seletor de filtro"
                    onchange="filtrarServidores()">
                    <option value="all">todos</option>
                    <option value="verde">verde</option>
                    <option value="amarelo">amarelo</option>
                    <option value="vermelho">vermelho</option>
                </select>
            </div>
            <button id="botaoInfo" class="botao-info" onclick="toggleInfo()"> <img class="icon-info"
                    src="./assets/infoPreta.png" alt="BotÃ£o de informaÃ§Ãµes"></button>

            <div id="infoDiv" class="info-div">
                <div class="superior-info">

                    <p>Indice</p>
                    <button id="closeButton" class="closeButton" onclick="toggleInfo()">X</button>

                </div>

                <div class="conteudo-legenda">
                    <div class="legenda-info">
                        <p>ðŸŸ¢</p>
                        <span><b>Indicador Verde</b>
                            <br> <br> Nenhum componente do servidor (CPU, MemÃ³ria RAM, Disco, Rede) estÃ¡ apresentando
                            problemas.</span>
                    </div>

                    <div class="legenda-info">
                        <p>ðŸŸ¡</p>
                        <span><b>Indicador Amarelo</b>
                            <br> <br> 1 (um) ou mais componentes do servidor (CPU, MemÃ³ria RAM, Disco, Rede) apresentam
                            problemas.</span>
                    </div>

                    <div class="legenda-info">
                        <p>ðŸ”´</p>
                        <span><b>Indicador Vermelho</b>
                            <br> <br> 2 (dois) ou mais componentes do servidor (CPU, MemÃ³ria RAM, Disco, Rede)
                            apresentam problemas.</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="line-cadastroServer">
            <button class="cadastro-servidor" onclick="openCadastro()">Cadastrar Servidor</button>
        </div>
        <div id="overlay">
            <div id="cadastroServer" class="cadastroServer">
                <h2 class="titulo">Cadastro de Servidor</h2>
                <button id="closeBtn" onclick="closeCadastro()" style="color: black;">X</button>
                <div class="fomulario-cadastroServer">
                    <p class="p-sever">Nome</p>
                    <input class="inp-server" type="text" name="" id="nomeDoServidor" alt="">
                    <p class="p-sever">Hostname</p>
                    <input class="inp-server" type="text" name="" id="hostNameServidor" alt="">
                    <p id="pErro" style="color: red;"></p>
                </div>
                <button onclick="efetuarCadastro()" class="btn-cadastrarServer">Cadastrar</button>
            </div>
        </div>

        <div id="overlay2">
            <div id="AlterarServer" class="AlterarServer">
                <h2 class="titulo">Alterar de Servidor</h2>
                <button id="closeBtnAlterar" onclick="closeAlterar()" style="color: black;">X</button>
                <div class="fomulario-AlterarServer">
                    <p class="p-sever">Novo Nome</p>
                    <input class="inp-server" type="text" name="" id="newServerName" alt="">
                    <p class="p-sever">Novo Hostname</p>
                    <input class="inp-server" type="text" name="" id="newHostName" alt="">
                    <p id="pErro2" style="color: red;"></p>
                </div>
                <button onclick="efetuarAlterar()" class="btn-cadastrarServer">Alterar</button>
            </div>
        </div>

        <div class="container-servidores" id="containerServidores"></div>
    </main>


</body>

</html>

<script>
    nomeUser.innerHTML = sessionStorage.NOME_USUARIO;
    console.log(sessionStorage.PARAMETROS_ALERTAS);
    console.log(sessionStorage.SERVIDORES);
    console.log("Lenght" + sessionStorage.PARAMETROS_ALERTAS.length)
    parametrosAlertas
    const idEmpresaUser = sessionStorage.ID_EMPRESA;

    if (sessionStorage.TIPO_ACESSO === 'Usuario PadrÃ£o') {
        
    }

    var parametrosAlertas = JSON.parse(sessionStorage.PARAMETROS_ALERTAS);

    var usoElevadoCpu = 0.0;
    var usuElevadoRam = 0.0;
    var usoElevadoDisco = 0.0;

    var cpuUp = 0;
    var ramUp = 0;
    var discoUp = 0;
    console.log(parametrosAlertas[0]);


    if (parametrosAlertas[0] === undefined) {
        fetch('/servidores/inserirParametrosDefault', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ idEmpresa: idEmpresaUser })
        })
            .then(response => response.json())
            .then(data => {
                alert('Parametros default inseridos com sucesso:', data);
                return fetch(`/servidores/obterParametros/${idEmpresaUser}`);
            })
            .then(response => response.json())
            .then(data => {
                sessionStorage.setItem('PARAMETROS_ALERTAS', JSON.stringify(data));
                location.reload();
            })
            .catch(error => {
                console.error('Erro ao inserir parametros default:', error);
            });
    }


    fetch(`/servidores/obterParametros/${idEmpresaUser}`)
        .then(response => response.json())
        .then(data => {
            console.log('Parametros:', data);
            sessionStorage.setItem('PARAMETROS_ALERTAS', JSON.stringify(data));
            console.log(sessionStorage.PARAMETROS_ALERTAS);

            parametros = data;
            parametros.forEach(parametro => {
                if (parametro.fk_tipo_componente === 1) {
                    paramMaxRam.innerHTML = parametro.parametro_max;
                    usoElevadoCpu = parametro.parametro_max;
                } else if (parametro.fk_tipo_componente === 2) {
                    paramMaxCpu.innerHTML = parametro.parametro_max;
                    usoElevadoRam = parametro.parametro_max;
                } else if (parametro.fk_tipo_componente === 3) {
                    paramMaxDisco.innerHTML = parametro.parametro_max;
                    usoElevadoDisco = parametro.parametro_max;
                }
            });


        })
        .catch(error => {
            console.error('Erro ao obter parametros:', error);
        });




    let dataServer = JSON.parse(sessionStorage.SERVIDORES);
    totalServers.innerHTML = dataServer.length;
    if (dataServer.length === 0) {
        totalServersCpuUp.innerHTML = "0";
        totalServersRamUp.innerHTML = "0";
        qtdDiscosMinSpace.innerHTML = "0";
        totalServers.innerHTML = "0";

        containerServidores.innerHTML = `<p class="sem-servidores">NÃ£o hÃ¡ servidores cadastrados</p>`;
    }

    containerServidores.innerHTML = "";
    totalServersCpuUp.innerHTML = cpuUp;
    totalServersRamUp.innerHTML = ramUp;
    qtdDiscosMinSpace.innerHTML = discoUp;
    dataServer.forEach((element, i) => {
        idServidor = element.id_servidor;
        let usoElevado = 0
        console.log(element.nome);
        fetch(`/servidores/dadosCPUeRAM/${idServidor}`)
            .then(response => response.json())
            .then(data => {
                console.log('Dados CPU e RAM:', data);
                console.log('CPU:', data[0].uso_cpu);
                console.log('RAM:', data[0].uso_ram);
                if (data[0].uso_cpu === undefined || data[0].uso_cpu === null){
                    data[0].uso_cpu = 0;
                    data[0].uso_ram = 0;
                }

                if (data[0].uso_cpu > usoElevadoCpu) {
                    usoElevado++;
                    cpuUp++;
                    Swal.fire({
                        title: 'AtenÃ§Ã£o!',
                        text: `O servidor ${element.nome} estÃ¡ com uso de CPU acima do normal!`,
                        icon: 'warning'
                    });

                    fetch(`/servidores/enviarAlertas`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            registro: data[0].uso_cpu,
                            componente: 1})
                    })
                        .then(response => response.json())
                        .then(data => {
                            console.log('Alerta enviado:', data);
                        })
                        .catch(error => {
                            console.error('Erro ao enviar alerta:', error);
                        });
                   
                } else if (data[0].uso_ram > usuElevadoRam) {
                    usoElevado++;
                    ramUp++;
                    Swal.fire({
                        title: 'AtenÃ§Ã£o!',
                        text: `O servidor ${element.nome} estÃ¡ com uso de RAM acima do normal!`,
                        icon: 'warning'
                    });
                    fetch(`/servidores/enviarAlertas`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            registro: data[0].uso_ram,
                            componente: 2})
                    })
                        .then(response => response.json())
                        .then(data => {
                            console.log('Alerta enviado:', data);
                        })
                        .catch(error => {
                            console.error('Erro ao enviar alerta:', error);
                        });
                }

            })
            .catch(error => {
                console.error('Erro ao obter dados de CPU e RAM:', error);
            });

        fetch(`/servidores/dadosDiscos/${idServidor}`)
            .then(response => response.json())
            .then(data => {
                console.log('Dados Disco:', data);
                console.log('Disco:', data[0].total_gib);

                data.forEach((element, i) => {
                    if (data[i].total_gib === undefined) data[i].total_gib = 0;

                    
                    if (((data[i].total_gib / data[i].uso) * 100) < usoElevadoDisco) {
                        usoElevado++;
                        discoUp++;
                        Swal.fire({
                            title: 'AtenÃ§Ã£o!',
                            text: `O servidor ${element.nome} estÃ¡ com pouco espaÃ§o em disco!`,
                            icon: 'warning'
                        });
                        fetch(`/servidores/enviarAlertas`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            registro: data[i].total_gib / data[i].uso * 100,
                            componente: 3})
                    })
                        .then(response => response.json())
                        .then(data => {
                            console.log('Alerta enviado:', data);
                        })
                        .catch(error => {
                            console.error('Erro ao enviar alerta:', error);
                        });
                    }
                });

            })
            .catch(error => {
                console.error('Erro ao obter dados de Disco:', error);
            });



        containerServidores.innerHTML += `
                <div class="conteudo-servidores">
               <div class="btns-acoes">
                 <button class="alterar-servidor" onclick="alterarServidor(${idServidor})">Alterar</button>
                   <button class="excluir-servidor" onclick="excluirServidor(${idServidor})">Excluir</button>
                </div>
                        <div class="card-servidores" id="servidor${idServidor}" onclick="redirecionarParaPagina(event)">
                            <span class="alocacao">
                                <p>${idServidor}</p>
                                <p id="colorAlerta"></p>
                            </span>
                            <div class="centralizar">
                                <img class="img-server" src="./assets/server.png" alt="">
                                <p class="nome-servidor">${element.nome}</p>
                            </div>
                        </div>
                    </div>`;

        if (usoElevado === 0) {
            colorAlerta.innerHTML = 'ðŸŸ¢';
        } else if (usoElevado === 1) {
            colorAlerta.innerHTML = 'ðŸŸ¡';
        } else if (usoElevado === 2) {
            colorAlerta.innerHTML = 'ðŸ”´';
        }

    });


    function efetuarCadastro() {
        alert('Clicou para cadastrar um novo servidor');
        var nomeServidor = nomeDoServidor.value;
        var hostServidor = hostNameServidor.value;
        if (nomeServidor == "" || hostServidor == "" || nomeServidor == null || hostServidor == null) {
            pErro.innerHTML = "Preencha todos os campos!";
            return false;
        } else {
            fetch(`/servidores/cadastrarServidor`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    nomeServer: nomeServidor,
                    hostNameServer: hostServidor,
                    idEmpresaServer: idEmpresaUser,
                }),
            })
                .then(function (resposta) {
                    console.log("resposta: ", resposta);
                    if (resposta.ok) {
                        Swal.fire({
                            title: "Cadastro realizado!",
                            text: "cadastro de servidor efetuado com sucesso!",
                            icon: "success"

                        });
                        setInterval(() => {
                            location.reload();
                        }, 2000);
                        return fetch(`/servidores/obterServidoresPorEmpresa/${idEmpresaUser}`);
                    } else {
                        throw Swal.fire({
                            title: "Erro no cadastro!",
                            icon: "error"
                        });
                    }
                })
                .catch(function (resposta) {
                    console.log(`#ERRO: ${resposta}`);
                });
            return false;
        }

    };

    fetch(`/servidores/obterServidoresPorEmpresa/${idEmpresaUser}`)
        .then(response => response.json())
        .then(data => {
            
            console.log('Servidores:', data);
            sessionStorage.setItem('SERVIDORES', JSON.stringify(data));
            console.log(sessionStorage.SERVIDORES);
            containerServidores.innerHTML = "";
            data.forEach((element, i) => {
                console.log(element.nome);

                containerServidores.innerHTML += `
                <div class="conteudo-servidores">
               <div class="btns-acoes">
                 <button class="alterar-servidor" onclick="alterarServidor(${element.id_servidor})">Alterar</button>
                   <button class="excluir-servidor" onclick="excluirServidor(${element.id_servidor})">Excluir</button>
                </div>
                        <div class="card-servidores" id="${element.id_servidor}" onclick="redirecionarParaPagina(event)">
                            <span class="alocacao">
                                <p>${element.id_servidor}</p>
                                <p>ðŸŸ¢</p>
                            </span>
                            <div class="centralizar">
                                <img class="img-server" src="./assets/server.png" alt="">
                                <p class="nome-servidor">${element.nome}</p>
                            </div>
                        </div>
                    </div>`;


            });
            totalServers.innerHTML = data.length;

        })
        .catch(error => {
            console.error('Erro ao obter servidores:', error);
        });


    function redirecionarParaPagina(event) {
        if (event.currentTarget.classList.contains('card-servidores')) {
            const servidorId = event.currentTarget.id;

            sessionStorage.setItem('id_serverSelecionado', servidorId);
            console.log(sessionStorage.id_serverSelecionado)

            alert('Clicou no servidor com ID: ' + servidorId);
            window.location.href = './painelInterno.html';
        }
    }









    function toggleInfo() {
        var botaoInfo = document.getElementById('botaoInfo');
        var infoDiv = document.getElementById('infoDiv');

        // botaoInfo.classList.remove('bounce');

        infoDiv.style.display = (infoDiv.style.display === 'block') ? 'none' : 'block';
    }

    function filtrarServidores() {
        var selectIndicador = document.getElementById('select-indicador');
        var indicadorSelecionado = selectIndicador.value;

        var servidores = document.querySelectorAll('.conteudo-servidores');

        servidores.forEach(function (servidor) {
            var indicadorServidor = servidor.querySelector('.alocacao p:nth-child(2)').textContent;

            if (indicadorSelecionado === 'all' || (indicadorSelecionado === 'verde' && indicadorServidor === 'ðŸŸ¢') || (indicadorSelecionado === 'amarelo' && indicadorServidor === 'ðŸŸ¡') || (indicadorSelecionado === 'vermelho' && indicadorServidor === 'ðŸ”´')) {
                servidor.style.display = 'block';
            } else {
                servidor.style.display = 'none';
            }
        });
    }


    function openCadastro() {
        document.getElementById("overlay").style.display = "block";
    }

    function closeCadastro() {
        document.getElementById("overlay").style.display = "none";
    }

    function openAlterar() {
        document.getElementById("overlay2").style.display = "block";
    }

    function closeAlterar() {
        document.getElementById("overlay2").style.display = "none";
    }



    let serverIdToAlter;

    function alterarServidor(id) {
        // alert('Clicou para alterar o servidor com ID: ' + id);
        serverIdToAlter = id;
        openAlterar();
    }

    function efetuarAlterar() {
        // alert('Clicou para alterar o servidor');
        var novoNomeServer = newServerName.value;
        var novoHostServer = newHostName.value;
        if (novoNomeServer == "" || novoHostServer == "" || novoNomeServer == null || novoHostServer == null) {
            pErro2.innerHTML = "Preencha todos os campos!";
            return false;
        } else {
            console.log("idServer: ", serverIdToAlter, novoNomeServer, novoHostServer),
                fetch(`/servidores/alterarServidor/${serverIdToAlter}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        novoNomeServer, novoHostServer
                    }),
                })
                    .then(function (resposta) {
                        console.log("resposta: ", resposta);
                        if (resposta.ok) {
                            Swal.fire({
                                title: "AlteraÃ§Ã£o realizada!",
                                text: "AlteraÃ§Ã£o de servidor efetuada com sucesso!",
                                icon: "success"
                            });
                            setInterval(() => {
                                location.reload();
                            }, 2000);
                            return fetch(`/servidores/obterServidoresPorEmpresa/${idEmpresaUser}`);
                        } else {
                            throw Swal.fire({
                                title: "Erro na alteraÃ§Ã£o!",
                                icon: "error"
                            });
                        }
                    })
                    .catch(function (resposta) {
                        console.log(`#ERRO: ${resposta}`);
                    });
            return false;
        }
    };



    function excluirServidor(id) {
        Swal.fire({
            title: 'Excluir Servidor',
            text: 'Tem certeza que deseja excluir o servidor com ID: ' + id + '?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sim, excluir',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {

                fetch(`/servidores/excluirServidor/${id}`, {
                    method: 'DELETE'
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Servidor excluÃ­do:', data);
                        Swal.fire(
                            'ExcluÃ­do!',
                            'O servidor foi excluÃ­do.',
                            'success'
                        );

                        setInterval(() => {
                            location.reload();
                        }, 2000);

                    })
                    .catch(error => {
                        console.error('Erro ao excluir servidor:', error);
                    });
            }
        });
    }

    function logout() {
        sessionStorage.clear();
        window.location.href = '../index.html'
    }
</script>