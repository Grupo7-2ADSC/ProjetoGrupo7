<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>List empresas</title>
  <link rel="stylesheet" href="empresas.css">
  <link rel="stylesheet" href="headerADM.css">
</head>

<body>
  <div class="header">
    <div class="container">
      <div class="logo">
        <a href="./empresas.html"><img class="imagem-logo" src="/assets/imagens/logoEmpresa.png" alt="logo empresa"></a>
      </div>
      <div class="navbar">
        <ul>
          <li><a href="./empresas.html">Empresas</a></li>
          <li><a href="usuarios.html">Usuários</a></li>
          <li><a href="./tiposacesso.html">Acessos</a></li>
        </ul>
      </div>
      <div id="user-profile" class="user-profile">
        <img class="img-user" src="./assets/userBranco.png" alt="">
        <div id="user-card" class="user-card">
          <div class="user-card-content">
            <p><span id="userName"></span> | ADM</p>
            <button id="logout-btn"><img class="icon-sair" src="./assets/exitBranco.png" alt="Icone de sair">Sair</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="container-table" id="containerTable">
    <div class="containerTittle">
      <h2>Lista de Empresas</h2>
      <button onclick="cadastrarEmpresa()">Cadastrar Empresa</button>
    </div>
    <table id="empresasTable">
      <thead>
        <tr>
          <th>Nome da Empresa</th>
          <th>CNPJ</th>
          <th>Data de Cadastro</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- <img src="" alt=""> -->
  </div>
</body>
</html>


<script>
  function cadastrarEmpresa() {
    window.location.href = "../adm/cadastroEmpresa.html";
  }

  document.addEventListener('DOMContentLoaded', function () {
    const userProfile = document.getElementById('user-profile');
    const userCard = document.getElementById('user-card');
    const logoutBtn = document.getElementById('logout-btn');
    const empresasTableBody = document.querySelector('#empresasTable tbody');
    const nomeUsuario = document.getElementById('userName');
    let empresas = [];

    nomeUsuario.innerHTML = sessionStorage.NOME_USUARIO;

    userProfile.addEventListener('click', function () {
      userCard.classList.toggle('active');
    });

    document.addEventListener('click', function (event) {
      if (!userProfile.contains(event.target) && !userCard.contains(event.target)) {
        userCard.classList.remove('active');
      }
    });

    logoutBtn.addEventListener('click', function () {
      sessionStorage.clear();
      window.location.href = '../index.html';
    });

    fetch('/empresas/listarEmpresas')
      .then(response => response.json())
      .then(data => {
        empresas = data;
        preencherTabela(empresas);
      })
      .catch(error => console.error('Error fetch empresas:', error));

    function preencherTabela(empresas) {
      empresasTableBody.innerHTML = '';
      empresas.forEach(empresa => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${empresa.nome}</td>
          <td>${empresa.cnpj}</td>
          <td>${empresa.data_cadastro}</td>
          <td>
            <button class="edit" onclick="editarEmpresa(${empresa.id_empresa})">Editar</button>
            <button class="delete" onclick="deletarEmpresa(${empresa.id_empresa})">Deletar</button>
          </td>
        `;
        empresasTableBody.appendChild(row);
      });
    }

    window.editarEmpresa = function (id) {
      const empresa = empresas.find(emp => emp.id_empresa === id);
      if (empresa) {
        const nome = prompt('Editar nome da empresa:', empresa.nome);
        const cnpj = prompt('Editar CNPJ da empresa:', empresa.cnpj);
        if (nome && cnpj) {
          fetch(`/empresas/editar/${id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ nome: nome, cnpj: cnpj })
          })
            .then(response => response.json())
            .then(data => {
              if (data.mensagem) {
                alert(data.mensagem);
                atualizarTabela();
              } else {
                alert('Erro ao editar empresa');
              }
            })
            .catch(error => console.error('Error:', error));
        }
      }
    };

    window.deletarEmpresa = function (id) {
      if (confirm('Tem certeza que deseja deletar esta empresa?')) {
        fetch(`/empresas/deletar/${id}`, {
          method: 'DELETE'
        })
          .then(response => response.json())
          .then(data => {
            if (data.mensagem) {
              alert(data.mensagem);
              atualizarTabela();
            } else {
              alert('Erro ao deletar empresa');
            }
          })
          .catch(error => console.error('Error:', error));
      }
    };

    function atualizarTabela() {
      fetch('/empresas/listarEmpresas')
        .then(response => response.json())
        .then(data => {
          empresas = data;
          preencherTabela(empresas);
        })
        .catch(error => console.error('Error fetch empresas:', error));
    }
  });
</script>