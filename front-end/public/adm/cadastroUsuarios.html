<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style-cadastros.css">
    <link rel="icon" href="../site/public/assets/imagens/iconNavegador.png" type="image/x-icon">
    <title>Cadastrar usuários</title>
</head>
<body>
  <div class="header">
    <div class="container">
      <div class="logo">
        <a href="./empresas.html"><img class="imagem-logo" src="/assets/imagens/logoEmpresa.png" alt="logo empresa"></a>
      </div>
      <div class="navbar">
        <ul>
          <li><a href="./empresas.html">Empresas</a></li>
          <li><a href="usuarios.html">Usuários</a></li>
          <li><a href="./tiposacesso.html">Acessos</a></li>
        </ul>
      </div>
      <div id="user-profile" class="user-profile">
        <img class="img-user" src="./assets/userBranco.png" alt="">
        <div id="user-card" class="user-card">
          <div class="user-card-content">
            <p><span id="userName"></span> | ADM</p>
            <button id="logout-btn"><img class="icon-sair" src="./assets/exitBranco.png" alt="Icone de sair">Sair</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="container-cadastro">
    <div class="alerta_erro">
      <div class="card_erro" id="cardErro">
        <span id="mensagem_erro"></span>
      </div>
    </div>
    <div class="container-form">
      <div class="cardCadastro card-cadastro">
        <h2>Cadastro de Usuários</h2>
        <div class="formulario">
          <div class="campo">
          </div>
          <div class="campo">
            <span>Nome</span>
            <input id="nome_input" type="text" placeholder="Nome" />
          </div>
          <div class="campo">
             <span>E-mail</span>
            <input id="email_input" type="email" placeholder="E-mail" />
          </div>
          <div class="campo">
            <span>Senha</span>
            <input id="senha_input" type="password" placeholder="Digite a senha do usuario" />
          </div>
          <div class="campo">
            <span>Empresa</span>
            <select id="empresasCadastradas" name="empresa" required>
            </select>
          </div>
          <div class="campo">
            <span>Tipo de acesso</span>
            <select id="tipoDeAcessoUser" name="tipoAcesso" required>
            </select>
          </div>
          <button class="botaoCadastro" onclick="cadastrar()">Cadastrar</button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>

<script>
    const userProfile = document.getElementById('user-profile');
    const userCard = document.getElementById('user-card');
    const logoutBtn = document.getElementById('logout-btn');
    const nomeUsuario = document.getElementById('userName');

    if (sessionStorage.NOME_USUARIO) {
      nomeUsuario.textContent = sessionStorage.NOME_USUARIO;
    }

    userProfile.addEventListener('click', function() {
      userCard.classList.toggle('active');
    });

    document.addEventListener('click', function(event) {
      if (!userProfile.contains(event.target) && !userCard.contains(event.target)) {
        userCard.classList.remove('active');
      }
    });

    logoutBtn.addEventListener('click', function () {
      sessionStorage.clear();
      window.location.href = '../index.html';
    });

  
    fetch('/empresas/listarEmpresas')
      .then(response => response.json())
      .then(data => {
        empresas = data;
        preencherEmpresas(empresas);
      })
      .catch(error => console.error('Error fetch empresas:', error));


    fetch('/empresas/listarAcessos')
      .then(response => response.json())
      .then(data => {
        acessos = data
        console.log(acessos)
        preencherAcessos(acessos)
      })
      .catch(error => console.error('Erro no fetch de acessos', error));

      function preencherEmpresas(empresa){
            empresas.forEach((empresa) => {
              empresasCadastradas.innerHTML += `<option value='${empresa.id_empresa}'>${empresa.nome}</option>`;
          });
      }

      function preencherAcessos(acessos){
            acessos.forEach((acessos) => {
              tipoDeAcessoUser.innerHTML += `<option value='${acessos.id_tipo_acesso}'>${acessos.tipo}</option>`;
          });
      }
  


  function cadastrar() {

    
    var nomeVar = nome_input.value;
    var emailVar = email_input.value;
    var senhaVar = senha_input.value;
    var empresaVar = empresasCadastradas.value;
    var acessoVar = tipoDeAcessoUser.value;

    
    if (nomeVar == "" || emailVar == "" || senhaVar == "" || empresaVar == "" || acessoVar == "") {
      alert("Preencha todos os campos!");
      return false;
    } else {
      fetch("/usuarios/cadastrarUser", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          nomeServer: nomeVar,
          emailServer: emailVar,
          senhaServer: senhaVar,
          empresaServer: empresaVar,
          acessoServer: acessoVar,
        }),
      })
        .then(function (resposta) {
          console.log("resposta: ", resposta);
          if (resposta.ok) {
            alert("Usuario cadastrado com sucesso!");
            location.reload();
          } else {
            throw "Houve um erro ao tentar realizar o cadastro de usuario!";
          }
        })
        .catch(function (resposta) {
          console.log(`#ERRO: ${resposta}`);
        });
      return false;
    }
  };
</script>